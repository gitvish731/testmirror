// perf/k6/vendor/acc.js  (pure ESM, k6 v0.46-safe)

// Internal structure:
// byFeature = { "<feature>": { count, sum, avg } }
// byEndpoint = { "<feature>": { "<endpoint>": { count, sum, avg } } }

const byFeature = Object.create(null);
const byEndpoint = Object.create(null);

function _ensureFeature(f) {
  if (!byFeature[f]) byFeature[f] = { count: 0, sum: 0, avg: 0 };
  if (!byEndpoint[f]) byEndpoint[f] = Object.create(null);
}

export function add(feature, endpoint, latencyMs) {
  _ensureFeature(feature);
  const f = byFeature[feature];
  f.count += 1;
  f.sum += Number(latencyMs) || 0;
  f.avg = f.count ? f.sum / f.count : 0;

  const epMap = byEndpoint[feature];
  if (!epMap[endpoint]) epMap[endpoint] = { count: 0, sum: 0, avg: 0 };
  const e = epMap[endpoint];
  e.count += 1;
  e.sum += Number(latencyMs) || 0;
  e.avg = e.count ? e.sum / e.count : 0;
}

export function snapshot() {
  // simple serializable copy
  return {
    byFeature: JSON.parse(JSON.stringify(byFeature)),
    byEndpoint: JSON.parse(JSON.stringify(byEndpoint)),
  };
}
